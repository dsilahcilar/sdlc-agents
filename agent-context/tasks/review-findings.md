# Review Findings: Template ‚Üí Generated Scripts Refactoring

**Date:** 2025-12-15
**Scope:** Uncommitted changes in main branch
**Impact:** Breaking changes to stack files and harness templates

---

## Executive Summary

Major refactoring reduces codebase by ~1,100 lines, shifting from verbose documentation to concise specifications. New features (Kotlin support, skill directives) are complete. Several broken references and documentation gaps need fixing before commit.

**Verdict:** üü° Fix critical issues, then ready to commit

---

## üî¥ CRITICAL - Fix Before Commit

### 1. Broken File References in Templates

**Issue:** All harness templates reference non-existent spec file

**Location:** `agents/templates/harness/*.sh`

**Current (broken):**
```bash
# See: $SDLC_AGENTS/skills/quality-gate-spec.md
```

**Should be:**
```bash
# See: $SDLC_AGENTS/skills/harness-spec.md
```

**Files to update:**
- `agents/templates/harness/run-quality-gates.sh:8`
- `agents/templates/harness/run-arch-tests.sh` (check if exists)
- `agents/templates/harness/run-feature.sh` (check if exists)
- `agents/templates/harness/init-project.sh` (check if exists)
- `agents/templates/harness/collect-metrics.sh` (check if exists)
- `agents/templates/harness/compare-metrics.sh` (check if exists)
- `agents/templates/harness/archive-metrics.sh` (check if exists)

**Action:**
```bash
# Search and fix all references
grep -r "quality-gate-spec\|arch-test-spec\|feature-runner-spec\|init-project-spec" agents/templates/harness/ --include="*.sh"
# Update to harness-spec.md
```

---

### 2. Broken References in MIGRATION_GUIDE.md

**Issue:** Migration guide references non-existent spec files

**Location:** `docs/MIGRATION_GUIDE.md:171-173`

**Current (broken):**
```markdown
- [Quality Gate Specification](../agents/skills/quality-gate-spec.md)
- [Architecture Test Specification](../agents/skills/arch-test-spec.md)
- [Feature Runner Specification](../agents/skills/feature-runner-spec.md)
- [Project Init Specification](../agents/skills/init-project-spec.md)
```

**Should be:**
```markdown
- [Harness Specification](../agents/skills/harness-spec.md)
- [Stack Detection](../agents/skills/stack-detection.md)
```

**Or create the missing spec files:**
- `agents/skills/quality-gate-spec.md` (specific to quality gates)
- `agents/skills/arch-test-spec.md` (specific to arch tests)
- `agents/skills/feature-runner-spec.md` (specific to feature runner)
- `agents/skills/init-project-spec.md` (specific to init)

**Action:** Choose one approach:
- **Option A:** Update MIGRATION_GUIDE.md to reference existing files
- **Option B:** Create the missing spec files by extracting sections from harness-spec.md

---

## üü° IMPORTANT - Should Fix Before Commit

### 3. Missing CHANGELOG Entry

**Issue:** No changelog documenting breaking changes

**Action:** Create `CHANGELOG.md` or update existing one with:

```markdown
## [Version] - 2025-12-15

### Breaking Changes

- **Stack files refactored**: All `agents/skills/stacks/*.md` files changed from verbose guides to concise specification format
  - Removed: Tool installation instructions, detailed examples, best practices
  - Kept: Detection rules, command tables, minimal rule templates
  - **Migration:** See `docs/MIGRATION_GUIDE.md`

- **Harness templates are now placeholders**: Templates in `agents/templates/harness/` no longer contain working code
  - Scripts must be generated by initializer agent
  - Projects using old templates must regenerate scripts

### New Features

- **Kotlin support**: Added `agents/skills/stacks/kotlin.md` with full Gradle/Maven support
  - Detection for `build.gradle.kts` with `*.kt` files
  - Support for Ktlint, Detekt, Kover, ArchUnit, Konsist

- **Skill directives**: Agents now support directive syntax in user prompts
  - `#SkillName` - Force-load skill
  - `#Skill1,Skill2` - Load multiple skills
  - `!SkillName` - Exclude skill
  - `#only:Skills` - Use only listed skills

- **Harness specification**: Added `agents/skills/harness-spec.md` defining output contract for generated scripts

### Improved

- **Stack detection**: Enhanced Kotlin vs Java detection logic
- **Code reduction**: Removed ~1,100 lines of redundant documentation
- **Maintainability**: Clearer separation between specs and guides

### Documentation

- Added `docs/MIGRATION_GUIDE.md` - Complete migration guide for template ‚Üí generated scripts
- Updated all agent files with skill directive documentation
```

---

### 4. Test Initializer Agent

**Issue:** Major changes to stack files and templates - need verification

**Action:** Test initializer agent generates working scripts for each stack:

**Test matrix:**
```bash
# Create test projects for each stack
mkdir -p /tmp/test-stacks/{java,kotlin,typescript,python,go,ruby,rust,dotnet,php}

# Java (Maven)
cd /tmp/test-stacks/java
cat > pom.xml << 'EOF'
<?xml version="1.0"?>
<project>
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.test</groupId>
  <artifactId>test</artifactId>
  <version>1.0</version>
</project>
EOF

# Kotlin (Gradle KTS)
cd /tmp/test-stacks/kotlin
cat > build.gradle.kts << 'EOF'
plugins {
    kotlin("jvm") version "1.9.0"
}
EOF
mkdir -p src/main/kotlin
echo "fun main() {}" > src/main/kotlin/Main.kt

# TypeScript
cd /tmp/test-stacks/typescript
cat > package.json << 'EOF'
{
  "name": "test",
  "version": "1.0.0"
}
EOF

# Python
cd /tmp/test-stacks/python
cat > pyproject.toml << 'EOF'
[project]
name = "test"
version = "1.0.0"
EOF

# Go
cd /tmp/test-stacks/go
cat > go.mod << 'EOF'
module test
go 1.21
EOF

# Ruby
cd /tmp/test-stacks/ruby
cat > Gemfile << 'EOF'
source 'https://rubygems.org'
EOF

# Rust
cd /tmp/test-stacks/rust
cat > Cargo.toml << 'EOF'
[package]
name = "test"
version = "1.0.0"
EOF

# .NET
cd /tmp/test-stacks/dotnet
cat > test.csproj << 'EOF'
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
  </PropertyGroup>
</Project>
EOF

# PHP
cd /tmp/test-stacks/php
cat > composer.json << 'EOF'
{
  "name": "test/test",
  "version": "1.0.0"
}
EOF
```

**For each stack:**
1. Run initializer agent
2. Verify scripts generated (not placeholders)
3. Check scripts are executable
4. Verify commands match stack specification
5. Test script execution (should fail gracefully if tools not installed)

---

### 5. Preserve Educational Content (Optional)

**Issue:** Lost ~1,700 lines of setup guides, examples, best practices

**Options:**

**Option A: Create guides directory**
```bash
# Move old content to guides
git show HEAD~N:agents/skills/stacks/java.md > docs/guides/java-architecture-guide.md
git show HEAD~N:agents/skills/stacks/python.md > docs/guides/python-architecture-guide.md
# ... for all stacks
```

**Option B: Link to external resources**
Add to each stack file:
```markdown
## Setup Guides

For detailed setup instructions, see:
- [ArchUnit Documentation](https://www.archunit.org/)
- [Stack-specific best practices](https://github.com/your-org/architecture-guides)
```

**Option C: Accept the loss**
- Agents can search web for setup instructions
- Keep specs minimal for LLM consumption

**Recommendation:** Option A or B for better user experience

---

## ‚ö†Ô∏è BREAKING CHANGES SUMMARY

### Impact Analysis

| Change | Affects | Severity | Migration Required |
|--------|---------|----------|-------------------|
| Stack files simplified | Users reading stack docs for reference | Medium | No (but worse UX) |
| Templates now placeholders | New projects | High | Yes (must run initializer) |
| Templates now placeholders | Existing projects with custom templates | High | Yes (see migration guide) |
| Kotlin detection priority | Kotlin projects detected as Java | Low | No (auto-fixes) |
| Removed tool installation docs | Users setting up new tools | Medium | No (can search web) |

### Users Who Need to Act

1. **New project creators:** Must run initializer agent (templates are placeholders)
2. **Custom template users:** Must migrate or regenerate scripts
3. **Documentation readers:** Reference material is now minimal
4. **Kotlin projects:** Will now be detected correctly (was Java before)

---

## ‚úÖ POSITIVE CHANGES

### What Works Well

1. **Cleaner architecture**
   - Separation of concerns: specs vs guides
   - 1,100 fewer lines to maintain
   - Easier to update stack commands

2. **New features complete**
   - Kotlin support fully documented
   - Skill directives system implemented
   - Migration guide comprehensive

3. **Better LLM consumption**
   - Concise tables vs verbose prose
   - Clear command reference
   - Minimal rule templates

4. **Improved accuracy**
   - Kotlin detection prevents misclassification
   - Stack-specific commands vs generic templates
   - Only generates commands for configured tools

---

## üìã ACTION ITEMS

### Before Commit (MUST DO)

- [ ] Fix template references: `quality-gate-spec.md` ‚Üí `harness-spec.md`
- [ ] Fix MIGRATION_GUIDE.md references (lines 171-173)
- [ ] Create or update CHANGELOG.md
- [ ] Decide on educational content preservation (Option A/B/C)

### Before Commit (SHOULD DO)

- [ ] Test initializer agent on all 9 stacks
- [ ] Verify generated scripts are executable
- [ ] Check generated scripts match specifications
- [ ] Review skill directive parser integration

### After Commit (NICE TO HAVE)

- [ ] Update external documentation referencing old stack format
- [ ] Notify users via announcement/email about breaking changes
- [ ] Consider semantic versioning for agent system
- [ ] Create video/tutorial on new generation workflow
- [ ] Add observability to track which stacks are most used

---

## üîç FILES TO REVIEW

### Modified Files with Potential Issues

```bash
# Check these for consistency
agents/templates/harness/init-project.sh
agents/templates/harness/run-arch-tests.sh
agents/templates/harness/run-feature.sh
agents/templates/harness/run-quality-gates.sh
agents/templates/harness/collect-metrics.sh  # if exists
agents/templates/harness/compare-metrics.sh  # if exists
agents/templates/harness/archive-metrics.sh  # if exists

# Verify these reference correct files
docs/MIGRATION_GUIDE.md
docs/skills/SKILL_DIRECTIVE_WORKFLOW.md

# Check for broken cross-references
agents/initializer-agent.md
agents/skills/stack-detection.md
```

### New Files to Verify

```bash
# Ensure these are complete
agents/skills/harness-spec.md
agents/skills/stacks/kotlin.md
docs/MIGRATION_GUIDE.md

# Verify these work
agents/tools/skills/parse-skill-directives.sh
agents/tools/skills/resolve-skills.sh
```

---

## üìä METRICS

### Code Changes

- **Total changed:** 18 files
- **Additions:** +741 lines
- **Deletions:** -1,883 lines
- **Net reduction:** -1,142 lines (-61%)

### Documentation Impact

| Stack | Before | After | Reduction |
|-------|--------|-------|-----------|
| .NET | 240 lines | 114 lines | -53% |
| Go | 217 lines | 71 lines | -67% |
| Java | 126 lines | 96 lines | -24% |
| PHP | 298 lines | 121 lines | -59% |
| Python | 187 lines | ~100 lines | -47% |
| Ruby | 260 lines | ~100 lines | -62% |
| Rust | 271 lines | ~100 lines | -63% |
| TypeScript | 168 lines | ~90 lines | -46% |
| **Total** | **1,767 lines** | **~792 lines** | **-55%** |

---

## üéØ PRIORITY ORDER

1. **P0 (Critical):** Fix broken file references in templates
2. **P0 (Critical):** Fix MIGRATION_GUIDE.md broken links
3. **P1 (High):** Create/update CHANGELOG.md
4. **P1 (High):** Test initializer agent on all stacks
5. **P2 (Medium):** Decide on educational content preservation
6. **P3 (Low):** Post-commit user notification
7. **P3 (Low):** External documentation updates

---

## ‚úçÔ∏è NOTES

### Design Philosophy Shift

**Old approach:** "Stack files are reference documentation for humans"
- Verbose explanations
- Multiple examples
- Best practices included
- Tool comparisons

**New approach:** "Stack files are specifications for LLM generation"
- Concise command tables
- Detection rules only
- Minimal examples
- No explanatory text

This is a **valid architectural decision** but should be:
1. Documented clearly
2. Communicated to users
3. Preserved somewhere for human reference

### Questions for Discussion

1. **Should we version the agent system itself?** (e.g., v1.0 ‚Üí v2.0)
2. **Where should educational content live?** (docs/ vs external wiki)
3. **How do we ensure LLMs generate correct scripts?** (validation, testing)
4. **Should templates have basic fallbacks?** (vs hard fail on generation required)

---

## üîó RELATED FILES

- Migration guide: `docs/MIGRATION_GUIDE.md`
- Harness spec: `agents/skills/harness-spec.md`
- Stack detection: `agents/skills/stack-detection.md`
- Skill workflow: `docs/skills/SKILL_DIRECTIVE_WORKFLOW.md`
- Git status at start of conversation (see assistant context)
